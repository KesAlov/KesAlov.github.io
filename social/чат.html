<script>
var timer = new Date();

function web_send_msg()

{

    // Получение значений из элементов ввода.

    var text = $("#WebChatTextID").val();

    var name = $("#WebChatNameID").val();

    

    // Очистка формы

    $("#WebChatTextID").val("");  

    

    // Запишем время в момент отправки сообщения

    timer = new Date();

        

    // Отправка сообщения в канал чата

    CometServer().web_pipe_send("web_chat_pipe", {"text":text, "name":name});

    

    // Уведомим остальные вкладки о том что мы добавили сообщение в чат

    comet_server_signal().send_emit("AddToChat", {"text":text, "name":name})

}

   

// Функция выполнится в после загрузки страницы

$(document).ready(function()

{  

    // Подписываемся на канал в который и будут отправляться сообщения чата. 

    CometServer().subscription("web_chat_pipe", function(msg){

        console.log(["msg", msg]);

        // Добавление полученного сообщения к списку сообщений.

        $("#WebChatFormForm").append("<p><b>"+HtmlEncode(msg.data.name)+": </b>"+HtmlEncode(msg.data.text)+"</p>");

    });

    // Подписываемся на событие добавления сообщения в чат нами, для того чтобы если чат открыт в нескольких вкладках

    // наше сообщение добавленное на одной вкладке отобразилось на всех остальных без перезагрузки страницы

    comet_server_signal().connect("AddToChat", function(msg){

        console.log(["msg", msg]);

        // Добавление полученного сообщения к списку сообщений.

        $("#WebChatFormForm").append("<p><b>"+HtmlEncode(msg.name)+": </b>"+HtmlEncode(msg.text)+"</p>");

    });

    

    // Подписываемся на канал в который и будут отправляется уведомления о доставке отправленных сообщений.

    CometServer().subscription("#web_chat_pipe", function(p)

    {

        // Запишем время в момент получения отчёта о доставке сообщения

        var etime = new Date();

        

        console.log(["answer_to_web_chat_pipe", p]);

        $("#answer_div").html("Сообщение доставлено "+p.data.number_messages+" получателям за "+ (etime.getTime() - timer.getTime() )+"ms");

        $("#answer_error").html(" "+p.data.error);

    });

});

function HtmlEncode(s)

{

  var el = document.createElement("div");

  el.innerText = el.textContent = s;

  s = el.innerHTML;

  return s;

}

</script>
<div style="border: 1px solid #ccc;padding:10px;">

	<div id="WebChatFormForm" style="overflow: auto;max-height: 100px;"></div>	<input type="text" id="WebChatNameID" style="margin-top:10px;" placeholder="Укажите ваше имя...">

	<div id="answer_div" style="float:right;"></div>

	<textarea id="WebChatTextID" placeholder="Отправьте сообщение в online чат..." style="max-width: 600px;max-height: 100px;width: 600px;margin-top:10px;display: block;"></textarea>

	<div style="margin-bottom: 0px;margin-top: 10px;">

		<input type="button" style="width: 220px;" onclick="web_send_msg();" value="Отправить"> 

		<div id="answer_error" style="float:right;"></div>

	</div>

</div>
