<?php 

// Подключаемся к комет серверу с логином и паролем для демо доступа (получить свои данные для подключения можно после регистрации на comet-server.ru )

// Логин 15

// Пароль lPXBFPqNg3f661JcegBY0N0dPXqUBdHXqj2cHf04PZgLHxT6z55e20ozojvMRvB8

// База данных CometQL_v1

$link = mysqli_connect("app.comet-server.ru", "15", "lPXBFPqNg3f661JcegBY0N0dPXqUBdHXqj2cHf04PZgLHxT6z55e20ozojvMRvB8", "CometQL_v1");

// Отправляем сообщение в канал

mysqli_query (  $link, "INSERT INTO pipes_messages (name, event, message)VALUES('SimplePhpChat', '', '".mysqli_real_escape_string($link,htmlspecialchars($_GET['text']))."' );" );
?>
<!DOCTYPE HTML>

<html>

<head>

    <!-- Подключаем библиотеки -->

    <script src="//comet-server.ru/CometServerApi.js" type="text/javascript"></script>

    <script src="//comet-server.ru/doc/CometQL/simplePhpChat/jquery.min.js" type="text/javascript"></script>

</head>

<body>

<!-- Блок в который мы добавим полученное сообщение -->

<div id="textHolder" style="margin-top:10px; border:1px solid #000;padding:10px;"></div>

<hr>

<input type="text" id="msgText" placeholder="Текст сообщения"><input type="button" value="Отправить"  onclick="sendMsg();">

Для связи с комет сервером используется <a href="http://comet-server.ru/wiki/doku.php/comet:cometql">CometQL</a>. CometQL - это api для работы с комет сервером по протоколу MySQL.

<script type="text/javascript">

$(document).ready(function(){

    /** 

     * Подписываемся на получение сообщения из канала SimplePhpChat

     */

    CometServer().subscription("SimplePhpChat", function(event){

        console.log("Мы получили сообщение из канала SimplePhpChat",  event.data, event);

        $("#textHolder").html( $("#textHolder").html() +"<hr>"+event.data);

    })

    /** 

     * Подключение к комет серверу. Для возможности принимать команды.

     * dev_id ваш публичный идентифиукатор разработчика

     */

    CometServer().start({dev_id:15 })

})

function sendMsg(){

	var text = $("#msgText").val();	

    jQuery.ajax({

        url: "//comet-server.ru/doc/CometQL/simplePhpChat/sendMsgToChat.php",

        type: "GET",

        data:"text="+encodeURIComponent(text),

        success: function(){

            $("#msgText").val('');

        }

    });

}

</script>

</body>

</html>
